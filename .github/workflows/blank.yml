name: Check File Sizes

on:
  workflow_call:
    inputs:
        ignored_paths:
          required: true
          type: string
        asset_paths:
          required: true
          type: string
        types:
          required: true
          type: string

jobs:
  check_file_sizes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    
    - name: Process types input
      id: process_types
      run: |
        echo "::set-output name=types::$(echo "$INPUT_TYPES" | awk '{for (i=1;i<=NF;i++) print $i}' | sed 's/:/=/g')"
    
    - name: Run file size check script
      id: report
      env:
        ignored_paths: ${{ inputs.ignored_paths }}
        asset_paths: ${{ inputs.asset_paths }}
        types: ${{ steps.process_types.outputs.types }}
      run: |
        echo $types
        OUTPUT=$(bash ./check.sh)
        if [[ $OUTPUT =~ "Error" ]]; then
          echo "${OUTPUT}"
          echo "${OUTPUT}" >> report.txt
          exit 1
        elif [[ $OUTPUT =~ "Warning" ]]; then
          echo "${OUTPUT}"
          echo "${OUTPUT}" >> report.txt
        else
          echo "All assets match required size"
        fi

    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.txt
