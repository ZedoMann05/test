name: Backup dev database

on:
  workflow_dispatch:
  pull_request:
    branches:
      - 'development'
      - 'master'
      - 'staging'

env:
  all_db_status: "getpin-main-dev-db,getpin-ai-dev-db,getpin-osm-dev-db,getpin-posts-dev-db,getpin-statistics-dev-db"

jobs:
  backup_dev_db:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: proj-dev

    strategy:
      matrix:
        Plan: [getpin-main-dev-db,getpin-ai-dev-db,getpin-osm-dev-db,getpin-posts-dev-db,getpin-statistics-dev-db]
    
    outputs:
      db_statuses: ${{ steps.steps_status.outputs.db_statuses }}

    steps:
      - name: Set up output object
        id: init_outputs
        run: echo "::set-output name=db_statuses::{}"

      - name: Create dump for ${{ matrix.Plan }}
        id: create_dump
        run: |
          DB_NAME=$(echo ${{ matrix.Plan }} | sed 's/-db//; s/-/_/g')
          gcloud sql export sql ${{ matrix.Plan }} --database $DB_NAME gs://getpin-backup-dev-db/${{ matrix.Plan }}/${DB_NAME}_$(TZ="Europe/Kiev" date +"%Y%m%d%H%M").sql

      - name: Update status object
        id: steps_status
        run: |
          echo "::set-output name=db_statuses::{\"${{ matrix.Plan }}\": \"${{ steps.create_dump.outcome }}\", ${{ needs.backup_dev_db.outputs.db_statuses }}"

  slack_notification:
    needs: backup_dev_db
    if: ${{ always() }}
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: proj-dev
        
    steps:
      - name: Setting Slack Notification
        if: ${{ always() }}
        run: |
          echo "${{ needs.backup_dev_db.outputs.db_statuses }}"
          echo "${{ env.all_db_status }}"


      # - name: Slack Notification
      #   if: ${{ always() }}
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_COLOR: ${{ needs.backup_dev_db.result }}
      #     SLACK_MESSAGE: ${{ env.SLACK_MESSAGE }}
      #     SLACK_TITLE: '${{ env.SLACK_TITLE }}'
      #     SLACK_FOOTER: 'Project: ${{ env.PROJECT_ID }}; Time: ${{ env.SLACK_FOOTER }}'
      #     SLACK_WEBHOOK: ${{ secrets.GETPIN_DEV_BACKUP_SLACK_CI_WEBHOOK }}
      #     SLACK_ICON: https://avatars.slack-edge.com/2023-02-15/4830237365520_6ec25f9ef61c9165fda5_48.jpg
      #     SLACKIFY_MARKDOWN: true