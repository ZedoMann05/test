name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        branch_name="${{ github.event.pull_request.head.ref }}"
        
        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾, Ñ‡Ð¸ Ñ–ÑÐ½ÑƒÑ” Ð³Ñ–Ð»ÐºÐ° Ñƒ Ñ€Ð¾Ð±Ð¾Ñ‡Ð¾Ð¼Ñƒ Ð´ÐµÑ€ÐµÐ²Ñ– Git
        if ! git show-ref --verify --quiet "refs/heads/$branch_name"; then
          echo "ðŸŸ¡ Branch $branch_name does not exist in the working tree."
          exit 0
        fi
        
        branch_pattern=$(echo "$branch_name" | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)
        
        # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ñ–Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ñ€Ð¸ ÐºÐ¾Ð¼Ñ–Ñ‚Ñ–Ð² Ð· Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ— Ð³Ñ–Ð»ÐºÐ¸
        commit_shas=$(git log --pretty=format:"%H" "$branch_name")
        
        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ ÐºÐ¾Ð¶ÐµÐ½ ÐºÐ¾Ð¼Ñ–Ñ‚
        for commit_sha in $commit_shas; do
          if git log --format=%B "$commit_sha" | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "ðŸŸ¢ Commit $commit_sha is valid according to regulation."
          else
            echo "ðŸ”´ Commit $commit_sha is not valid according to regulation."
            exit 1
          fi
        done
        
        # Ð¯ÐºÑ‰Ð¾ Ð²ÑÑ– ÐºÐ¾Ð¼Ñ–Ñ‚Ð¸ Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð¸ Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–ÑŽ
        echo "# Validate Commit" > ./report.md
        echo "All commits are valid according to regulation." >> ./report.md
        exit 0
    
    - name: Post comment on Pull Request
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
