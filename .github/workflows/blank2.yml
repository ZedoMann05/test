name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Commit
      run: |
        # ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ SHA Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ ÐºÐ¾Ð¼Ñ–Ñ‚Ñƒ Ð² Ð³Ñ–Ð»Ñ†Ñ–, Ð½Ð° ÑÐºÑƒ Ð²Ð¸ Ð·Ð´Ñ–Ð¹ÑÐ½Ð¸Ð»Ð¸ push
        head_sha=$(git rev-parse HEAD)

        # ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð´Ð»Ñ Ð³Ñ–Ð»ÐºÐ¸ (Ð²Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ "refs/heads/")
        branch_pattern=$(echo ${{ github.head_ref }} | sed 's|refs/heads/||')

        # ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ SHA Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½ÑŒÐ¾Ð³Ð¾ ÐºÐ¾Ð¼Ñ–Ñ‚Ñƒ, Ñ‰Ð¾Ð± Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ Ð¹Ð¾Ð³Ð¾ ÑÐº Ñ‚Ð¾Ñ‡ÐºÑƒ Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð´Ð»Ñ Ñ„Ñ–Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ñ–Ñ— ÐºÐ¾Ð¼Ñ–Ñ‚Ñ–Ð²
        previous_sha=$(git rev-parse HEAD^)

        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ð²ÑÑ– ÐºÐ¾Ð¼Ñ–Ñ‚Ð¸, Ñ‰Ð¾ Ð±ÑƒÐ»Ð¸ Ð´Ð¾Ð´Ð°Ð½Ñ– Ð¿Ñ–Ð´ Ñ‡Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ Ð¿ÑƒÑˆÑƒ
        while read -r commit_hash; do
          if git log -1 --format=%B $commit_hash | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "# Validate Commit" > ./report.md
            echo "Your commit - $(git log -1 --format=%B $commit_hash)" >> ./report.md
            echo "ðŸŸ¢ There are valid commits according to regulation." >> ./report.md
          else
            echo "# Validate Commit" > ./report.md
            echo "Your commit - $(git log -1 --format=%B $commit_hash)" >> ./report.md
            echo "ðŸ”´ There are no valid commits according to regulation." >> ./report.md
            exit 1
          fi
        done <<< "$(git log --format=%H --since=$previous_sha)"
    
    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md