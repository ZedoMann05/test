name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Commit
      run: |
        git fetch origin ${{ github.event.pull_request.head.ref }}
        
        git fetch origin ${{ github.event.pull_request.base.ref }}

        head_sha=$(git rev-parse origin/${{ github.event.pull_request.head.ref }})
        
        base_sha=$(git rev-parse origin/${{ github.event.pull_request.base.ref }})

        branch_pattern=$(echo ${{ github.event.pull_request.head.ref }} | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)
        
        # if git log --format=%s $base_sha..$head_sha | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
        #   echo "# Validate Commit" > ./report.md
        #   echo "Your commit - $(git log --format=%s $base_sha..$head_sha)" >> ./report.md
        #   echo "ðŸŸ¢ There are valid commits according to regulation." >> ./report.md
        #   exit 0
        # else
        #   echo "# Validate Commit" > ./report.md
        #   echo "Your commit - $(git log -1 --format=%s $base_sha..$head_sha)" >> ./report.md
        #   echo "ðŸ”´ There is no commits that are valid according to regulation" >> ./report.md
        #   exit 1
        # fi

        git log --format=%s $base_sha..$head_sha > commit_log.txt

        # Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ Ð·Ð¼Ñ–Ð½Ð½Ð¾Ñ—, Ñ‰Ð¾ Ð¿Ð¾Ð·Ð½Ð°Ñ‡Ð°Ñ” ÑÑ‚Ð°Ð½ Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ—
        valid_commits=0

        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÐºÐ¾Ð¼Ñ–Ñ‚Ñ–Ð² Ð· Ñ„Ð°Ð¹Ð»Ñƒ Ð·Ð° Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð¾ÑŽ Ñ†Ð¸ÐºÐ»Ñƒ
        while IFS= read -r commit; do
            # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°, Ñ‡Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ” ÐºÐ¾Ð¼Ñ–Ñ‚ ÑƒÐ¼Ð¾Ð²Ñ–
            if echo "$commit" | grep -q -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
                # Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ð¼Ñ–Ñ‚ Ð²Ð°Ð»Ñ–Ð´Ð½Ð¸Ð¹, Ð·Ð±Ñ–Ð»ÑŒÑˆÑƒÑ”Ð¼Ð¾ Ð»Ñ–Ñ‡Ð¸Ð»ÑŒÐ½Ð¸Ðº Ð²Ð°Ð»Ñ–Ð´Ð½Ð¸Ñ… ÐºÐ¾Ð¼Ñ–Ñ‚Ñ–Ð²
                ((valid_commits++))
            else
                # Ð¯ÐºÑ‰Ð¾ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð½ÐµÐ²Ð°Ð»Ñ–Ð´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ñ–Ñ‚, Ð²Ð¸Ð²Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÑƒÑ”Ð¼Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚
                echo "# Validate Commit" > ./report.md
                echo "ðŸ”´ There is at least one commit that is not valid according to regulation" >> ./report.md
                exit 1
            fi
        done < commits.txt
    
    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
