name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        branch_name="${{ github.event.pull_request.head.ref }}"
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –≥—ñ–ª–∫–∞ —É —Ä–æ–±–æ—á–æ–º—É –¥–µ—Ä–µ–≤—ñ Git
        if ! git show-ref --verify --quiet "refs/heads/$branch_name"; then
          echo "üü° Branch $branch_name does not exist in the working tree."
        fi
        
        branch_pattern=$(echo "$branch_name" | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)
        
        # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –∫–æ–º—ñ—Ç—ñ–≤ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –≥—ñ–ª–∫–∏
        commit_shas=$(git log --pretty=format:"%H" "$branch_name")

        echo "# Validate Commit" > ./report.md
        echo "All commits are valid according to regulation." >> ./report.md
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–µ–Ω –∫–æ–º—ñ—Ç
        for commit_sha in $commit_shas; do
          if git log --format=%B "$commit_sha" | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "üü¢ Commit $commit_sha is valid according to regulation." >> ./report.md
          else
            echo "üî¥ Commit $commit_sha is not valid according to regulation." >> ./report.md
            exit 1
          fi
        done
        
        # –Ø–∫—â–æ –≤—Å—ñ –∫–æ–º—ñ—Ç–∏ –ø—Ä–æ–π—à–ª–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
        exit 0
    
    - name: Post comment on Pull Request
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
