name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        # Знаходимо кількість комітів, що додані у Pull Request
        commit_count=$(git rev-list --count HEAD ^origin/${{ github.event.pull_request.base.ref }})

        # Отримуємо список SHA комітів, що були додані у Pull Request
        commit_list=$(git rev-list --reverse HEAD ^origin/${{ github.event.pull_request.base.ref }})

        # Перевіряємо кожен коміт
        for sha in $commit_list; do
          commit_message=$(git log --format=%B -n 1 $sha)
          branch_pattern=$(echo ${{ github.event.pull_request.head.ref }} | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)

          if echo "$commit_message" | grep -qE "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "Valid commit: $commit_message"
          else
            echo "Invalid commit: $commit_message"
            exit 1
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}