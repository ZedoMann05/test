name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        # –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ –∫–æ–º—ñ—Ç—ñ–≤
        validate_commits() {
          valid_commits=0
          invalid_commits=0
          
          # –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–æ–º—ñ—Ç–∏ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
          while read -r commit; do
            if echo "$commit" | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
              valid_commits=$((valid_commits + 1))
            else
              invalid_commits=$((invalid_commits + 1))
            fi
          done <<< "$(git log --format=%B $range_start..$range_end)"
          
          # –í–∏–≤—ñ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
          echo "# Validate Commit" > ./report.md
          echo "üü¢ Valid commits: $valid_commits" >> ./report.md
          echo "üî¥ Invalid commits: $invalid_commits" >> ./report.md
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –≤–∏—Ö–æ–¥—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
          if [ $invalid_commits -eq 0 ]; then
            echo "üü¢ All commits are valid according to regulation." >> ./report.md
            exit 0
          else
            echo "üî¥ There are invalid commits according to regulation" >> ./report.md
            exit 1
          fi
        }

        # –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É –∫–æ–º—ñ—Ç—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        if [ -n "${{ github.event.pull_request }}" ]; then
          # –Ø–∫—â–æ —Ü–µ –ø—É–ª–ª —Ä–µ–∫–≤–µ—Å—Ç
          range_start=$(git rev-parse ${{ github.event.pull_request.base.ref }}) # –ë–∞–∑–æ–≤–∏–π –∫–æ–º—ñ—Ç
          range_end=$(git rev-parse ${{ github.event.pull_request.head.ref }})   # –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–º—ñ—Ç
        else
          # –Ø–∫—â–æ —Ü–µ –ø—Ä–æ—Å—Ç–∏–π –ø—É—à
          range_start=${{ github.event.before }}
          range_end=${{ github.event.after }}
        fi
        
        # –û—Ç—Ä–∏–º–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É –≥—ñ–ª–∫–∏
        branch_pattern=$(echo ${{ github.event.pull_request.head.ref }} | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)

        # –í–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ –∫–æ–º—ñ—Ç—ñ–≤
        validate_commits
        
    - name: Post comment on Pull Request
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
