name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Commit
      run: |
        # Отримати SHA останнього коміту в гілці, на яку ви здійснили push
        head_sha=$(git rev-parse HEAD)

        # Отримати шаблон для гілки (видаляємо "refs/heads/")
        branch_pattern=$(echo ${{ github.head_ref }} | sed 's|refs/heads/||')

        # Отримати SHA попереднього коміту, щоб використовувати його як точку початку для фільтрації комітів
        previous_sha=$(git rev-parse HEAD^)

        # Перевірити всі коміти, що були додані під час останнього пушу
        while read -r commit_hash; do
          if git log -1 --format=%B $commit_hash | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "# Validate Commit" > ./report.md
            echo "Your commit - $(git log -1 --format=%B $commit_hash)" >> ./report.md
            echo "🟢 There are valid commits according to regulation." >> ./report.md
          else
            echo "# Validate Commit" > ./report.md
            echo "Your commit - $(git log -1 --format=%B $commit_hash)" >> ./report.md
            echo "🔴 There are no valid commits according to regulation." >> ./report.md
            exit 1
          fi
        done <<< "$(git log --format=%H --since=$previous_sha)"
    
    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md