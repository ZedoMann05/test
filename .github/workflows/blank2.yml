name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          base_ref=$(jq -r '.pull_request.base.ref' $GITHUB_EVENT_PATH)
          head_ref=$(jq -r '.pull_request.head.ref' $GITHUB_EVENT_PATH)
          git diff --name-only $base_ref...$head_ref | while read -r file; do
            if git log --no-merges --oneline $base_ref...$head_ref -- $file | grep -qE "^(fix|hotfix|bugfix|feat|feature|breaking)\($head_ref\)?:.+"; then
              echo "File $file contains valid commits."
            else
              echo "File $file does not contain valid commits."
              exit 1
            fi
          done
          echo "All files contain valid commits."
          exit 0
        else
          echo "This is not a pull request. Exiting..."
          exit 0
        fi
    
    - name: Post comment on Pull Request
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
