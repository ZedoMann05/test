name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate Commit
      run: |
        git fetch origin ${{ github.event.pull_request.head.ref }}
        
        git fetch origin ${{ github.event.pull_request.base.ref }}

        head_sha=$(git rev-parse origin/${{ github.event.pull_request.head.ref }})
        
        base_sha=$(git rev-parse origin/${{ github.event.pull_request.base.ref }})

        branch_pattern=$(echo ${{ github.event.pull_request.head.ref }} | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)
        
        # if git log --format=%s $base_sha..$head_sha | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
        #   echo "# Validate Commit" > ./report.md
        #   echo "Your commit - $(git log --format=%s $base_sha..$head_sha)" >> ./report.md
        #   echo "üü¢ There are valid commits according to regulation." >> ./report.md
        #   exit 0
        # else
        #   echo "# Validate Commit" > ./report.md
        #   echo "Your commit - $(git log -1 --format=%s $base_sha..$head_sha)" >> ./report.md
        #   echo "üî¥ There is no commits that are valid according to regulation" >> ./report.md
        #   exit 1
        # fi

        git log --format=%s $base_sha..$head_sha > commit_log.txt

        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–æ—ó, —â–æ –ø–æ–∑–Ω–∞—á–∞—î —Å—Ç–∞–Ω –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
        valid_commits=0

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–º—ñ—Ç—ñ–≤ –∑ —Ñ–∞–π–ª—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü–∏–∫–ª—É
        while IFS= read -r commit; do
            # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∫–æ–º—ñ—Ç —É–º–æ–≤—ñ
            if echo "$commit" | grep -q -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
                # –Ø–∫—â–æ –∫–æ–º—ñ—Ç –≤–∞–ª—ñ–¥–Ω–∏–π, –∑–±—ñ–ª—å—à—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –≤–∞–ª—ñ–¥–Ω–∏—Ö –∫–æ–º—ñ—Ç—ñ–≤
                ((valid_commits++))
            fi
        done < commit_log.txt

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —î —Ö–æ—á–∞ –± –æ–¥–∏–Ω –≤–∞–ª—ñ–¥–Ω–∏–π –∫–æ–º—ñ—Ç
        if ((valid_commits > 0)); then
            echo "# Validate Commit" > ./report.md
            echo "üü¢ There are valid commits according to regulation." >> ./report.md
            exit 0
        else
            # –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö –∫–æ–º—ñ—Ç—ñ–≤, –≤–∏–≤–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É —Ç–∞ –∑–∞–≤–µ—Ä—à—É—î–º–æ —Å–∫—Ä–∏–ø—Ç
            echo "# Validate Commit" > ./report.md
            echo "üî¥ There is no commits that are valid according to regulation" >> ./report.md
            exit 1
        fi
    
    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
