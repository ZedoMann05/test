name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
        
    - name: Validate Commit
      run: |
        git fetch origin ${{ github.event.pull_request.head.ref }}
        
        git fetch origin ${{ github.event.pull_request.base.ref }}

        head_sha=$(git rev-parse origin/${{ github.event.pull_request.head.ref }})
        
        base_sha=$(git rev-parse origin/${{ github.event.pull_request.base.ref }})

        git log --format=%s $base_sha..$head_sha > commits.txt

        echo "validate_commit=true" >> $GITHUB_ENV

        while IFS= read -r commit; do
            if ! ( grep -q -i -E "^(fix|hotfix|bugfix|feat|feature|breaking|chore)((.+))?:.+" <<< "$commit" || grep -q -i -E "^(fix|hotfix|bugfix|feat|feature|breaking|chore) ((.+))?:.+" <<< "$commit" || grep -q -i -E "^(fix|hotfix|bugfix|feat|feature|breaking|chore)?:.+" <<< "$commit" || grep "Merge" <<< "$commit" ); then
                echo $commit >> ./commit.txt
                echo "validate_commit=false" >> $GITHUB_ENV
            fi
            cat commits.txt
        done < "commits.txt"

    - name: Create report
      run: |
        echo "# Validate Commit" > ./report.md

        if [ ${{ env.validate_commit }} = false ]; then
            echo "ðŸ”´ There is no commits that are valid according to regulation" >> ./report.md
            echo "Commits that do not meet the requirements:" >> ./report.md
            cat commit.txt >> ./report.md
            exit 1
        else
            echo "ðŸŸ¢ There are valid commits according to regulation." >> ./report.md
        fi
    
    - name: Post report as comment
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
