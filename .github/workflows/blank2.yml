name: Check commit

on:
  workflow_call:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Validate Commits
      run: |
        # ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ–Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ñ€Ñ–Ð² ÐºÐ¾Ð¼Ñ–Ñ‚Ñ–Ð², Ð¿Ð¾Ð²'ÑÐ·Ð°Ð½Ð¸Ñ… Ð· Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¼ Pull Request
        commits=($(echo "${{ github.event.pull_request.commits }}" | tr -d '[],'))
        
        branch_pattern=$(echo ${{ github.event.pull_request.head.ref }} | grep -oE '\/([a-zA-Z0-9_-]+)\/' | cut -d'/' -f2)
        
        # ÐŸÐµÑ€ÐµÐ±Ð¸Ñ€Ð°Ñ”Ð¼Ð¾ ÐºÐ¾Ð¼Ñ–Ñ‚Ð¸ Ñ– Ð²Ð°Ð»Ñ–Ð´ÑƒÑ”Ð¼Ð¾ Ñ—Ñ…
        for commit_sha in "${commits[@]}"; do
          if git log --format=%B "$commit_sha" | grep -E "^(fix|hotfix|bugfix|feat|feature|breaking)\($branch_pattern\)?:.+"; then
            echo "ðŸŸ¢ Commit $commit_sha is valid according to regulation."
          else
            echo "ðŸ”´ Commit $commit_sha is not valid according to regulation."
            exit 1
          fi
        done
        
        # Ð¯ÐºÑ‰Ð¾ Ð²ÑÑ– ÐºÐ¾Ð¼Ñ–Ñ‚Ð¸ Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð¸ Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–ÑŽ
        echo "# Validate Commit" > ./report.md
        echo "All commits are valid according to regulation." >> ./report.md
        exit 0
    
    - name: Post comment on Pull Request
      if: ${{ always() }}
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: ./report.md
